---
title: "Yojoa-LS4-9-collate-explore"
author: "B Steele"
date: "2023-02-13"
output: html_document
---

# Purpose

# Setup

```{r}
library(googledrive)
library(tidyverse)
library(lubridate)

data_dir = file.path('data/')

drive_auth()
```

# Download and collate data and metadata from Drive

Download and collate data and metadata into separate files.

```{r}
#get a file list
files = drive_ls(path = 'yojoa')

#make a tmp dir
dir.create('tmp')

#function for downloading
dr_down = function(filename, fileid){
  drive_download(file = as_id(fileid), path = file.path('tmp', filename))
}

#map over the function to download all files
map2(files$name, files$id, dr_down)

# create a list of the files in the tmp directory
list = list.files('tmp')
#add the prefix to them
list = paste0('tmp/', list)

meta_list = list[grepl('meta', list)]
data_list = list[!grepl('meta', list)]

#read them in and map to a dataframe
collated_data = map_dfr(data_list, read_csv)
collated_metadata = map_dfr(meta_list, read_csv)

#clean up workspace
rm(files)
```

Reformat the data system:index so that it will play nicely with the metadata and so we pull out the site rowid.

```{r}
grabRowid = function(sys_idx){
  parsed = str_split(sys_idx, '_')
  str_len = length(unlist(parsed))
  unlist(parsed)[str_len]
}

grabSystemIndex = function(sys_idx){
  parsed = str_split(sys_idx, '_')
  str_len = length(unlist(parsed))
  parsed_sub = unlist(parsed)[1:(str_len-1)]
  str_flatten(parsed_sub, collapse = '_')
}

collated_data$rowid = map(collated_data$`system:index`,grabRowid)
collated_data$`system:index` = map(collated_data$`system:index`, grabSystemIndex)

collated_data$`system:index` = as.character(collated_data$`system:index`)
```

Grab only the metadata we want

```{r}
filtered_metadata <- collated_metadata %>% 
  select(`system:index`, WRS_PATH, WRS_ROW, SPACECRAFT_ID, DATE_ACQUIRED, SCENE_CENTER_TIME, CLOUD_COVER, IMAGE_QUALITY, IMAGE_QUALITY_OLI, IMAGE_QUALITY_TIRS, SUN_AZIMUTH, SUN_ELEVATION)
  
```

Join the data and metadata.

```{r}
data = left_join(collated_data, collated_metadata)

#clean up workspace
rm(collated_data, collated_metadata)
```

## Filter scene summaries

Filter for at least 10 pixels in pCount_dswe1 (confident water)

```{r}
filtered = data %>% 
  filter(pCount_dswe1 > 10)
```

## Parse out system:index

Create new parameters of date, rowid, and satellite, and bring them to the front of the df

```{r}
grabDate = function(sys_idx){
  parsed = str_split(sys_idx, '_')
  str_len = length(unlist(parsed))
  unlist(parsed)[str_len-1]
}

grabSat = function(sys_idx){
  parsed = str_split(sys_idx, '_')
  str_len = length(unlist(parsed))
  unlist(parsed)[grep('L', unlist(parsed))]
}

filtered$date = map(filtered$`system:index`, grabDate)
filtered$sat = map(filtered$`system:index`, grabSat)

filtered <- filtered %>% 
  select(date, rowid, sat, med_Blue:)
```

## Format date, join with location identifiers

### Read location info in

```{r}
locs = read.csv(file.path(data_dir, 'location_lat_longs_YOJOA.csv')) %>% 
  rowid_to_column() %>% 
  select(rowid, location)
```

```{r}
filtered$date = ymd(filtered$date)

filtered <- filtered %>% 
  mutate(rowid = as.integer(rowid),
         sat = as.character(sat)) %>% 
  full_join(., locs)
```

# Landsat 4,5,7 to 8,9 handoff

Summarize where there is more than one satellite in a given day.

```{r}
summary = filtered %>% 
  group_by(date, location) %>% 
  summarize(n = n(),
            dup_sat = toString(sat)) 

filtered <- full_join(filtered, summary)

```

Filter for dates with more than 1 satellite mission image, pivot data, and create a harmonized 8/9 column

```{r}
subset = filtered %>% filter(n>1) %>% select(date, sat, location, pCount_dswe, pCount_dswe3, min_cloud_dist) 
qa <- filtered %>% filter(n>1) %>% 
  select(med_Blue:med_Swir2, sat, date, location) %>% 
  pivot_longer(cols = c(med_Blue:med_Swir2),
              names_to = 'band',
              values_to = 'values') %>% 
  pivot_wider(names_from = sat,
              values_from = values) %>% 
  mutate(L89 = ifelse(!is.na(LC08), LC08, LC09)) 
```

need to add sat id to minclouddist

Check relationships

```{r}
ggplot(qa, aes(x = L89, y = LE07, color = band)) +
  geom_point(aes(size = min_cloud_dist)) +
  theme_bw() +
  geom_smooth(method = 'lm', se = F)

lm_blue = lm(qa[qa$band == 'med_Blue',]$mean_LE07 ~qa[qa$band == 'med_Blue',]$mean_L89)
summary(lm_blue)

lm_green = lm(qa[qa$band == 'med_Green',]$mean_LE07 ~qa[qa$band == 'med_Green',]$mean_L89)
summary(lm_green)

lm_nir = lm(qa[qa$band == 'med_Nir',]$mean_LE07 ~qa[qa$band == 'med_Nir',]$mean_L89)
summary(lm_nir)

lm_red = lm(qa[qa$band == 'med_Red',]$mean_LE07 ~qa[qa$band == 'med_Red',]$mean_L89)
summary(lm_red)

lm_sw1 = lm(qa[qa$band == 'med_Swir1',]$mean_LE07 ~qa[qa$band == 'med_Swir1',]$mean_L89)
summary(lm_sw1)

lm_sw2 = lm(qa[qa$band == 'med_Swir2',]$mean_LE07 ~qa[qa$band == 'med_Swir2',]$mean_L89)
summary(lm_sw2)
```
